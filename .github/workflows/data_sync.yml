name: Data Sync (issue JSON)

on:
  # Рачно стартување за тест
  workflow_dispatch:
  # Автоматски кога ќе отвориш/уредиш issue
  issues:
    types: [opened, edited]

jobs:
  parse:
    runs-on: ubuntu-latest

    steps:
      - name: Show raw issue body (debug)
        run: |
          echo '--- RAW (JSON-escaped) ---'
          echo '${{ toJson(github.event.issue.body) }}' | head -c 2000
          echo
          echo '--- /RAW ---'

      - name: Extract fenced ```json block to payload.json
        id: extract
        shell: bash
        run: |
          set -euo pipefail

          # Претвори го issue body-то од JSON string во чист текст
          BODY_JSON='${{ toJson(github.event.issue.body) }}'
          BODY=$(printf "%s" "$BODY_JSON" | jq -r .)

          # Извлечи го содржајот меѓу ```json ... ```
          JSON=$(printf "%s\n" "$BODY" \
            | awk '/```json/{flag=1;next}/```/{if(flag){flag=0;exit}}flag')

          # Сними во фајл
          printf "%s\n" "$JSON" > payload.json

          # Емитувај како output (за следни чекори)
          {
            echo "json<<JSON_EOF"
            printf "%s\n" "$JSON"
            echo "JSON_EOF"
          } >> "$GITHUB_OUTPUT"

          echo "Extracted JSON to payload.json"

      - name: Validate JSON (optional)
        shell: bash
        run: |
          if [ -s payload.json ]; then
            echo "payload.json content:"
            cat payload.json
            echo
            echo "jq validation:"
            jq . payload.json
          else
            echo "No JSON block found between ```json ... ```"
          fi
